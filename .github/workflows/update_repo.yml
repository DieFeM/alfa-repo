# Release script for Alfa Addon 
name: update

on:
  workflow_dispatch:

# Set permissions for GitHub key
permissions: write-all

jobs:
  deploy:
    name: Update repository
    runs-on: ubuntu-latest

    env:
      GIT_USER_NAME: Alfa
      GIT_USER_EMAIL: alfa-add-on@users.noreply.github.com

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Configure Python 3.13
        uses: actions/setup-python@v2
        with:
          python-version: '3.13'

      - name: Set-up environment
        run: |
          git config --global user.name "[CI] Alfa"
          git config --global user.email "alfa-add-on@users.noreply.github.com"
          pip install lxml

      - name: Generating repo
        run: |
          echo "Entering Git repo directory"
          cd ${{ github.workspace }}
          BLACKLIST="downloads mediaserver"
          EXCLUDES=""
          for pattern in $BLACKLIST; do
            export EXCLUDES="$EXCLUDES -not -path \"./$pattern/*\"";
          done;
          export ADDON_ZIPS=$(eval "find . -maxdepth 2 -type f -name '*.zip' $EXCLUDES")
          echo "The following zips found"
          echo $ADDON_ZIPS
          echo "Updating repository"
          python create_repository.py $ADDON_ZIPS
          git add .
          git commit -m "Updated addons.xml and md5's"
          git push
          echo "Update finished!"
